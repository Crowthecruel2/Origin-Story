<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Origin Story | Power Library</title>
  <style>
    :root {
      --bg: #050910;
      --panel: #0d1624;
      --card: #0f1c2d;
      --border: #233449;
      --accent: #38f2c7;
      --accent-2: #6dd3ff;
      --text: #e6ebf5;
      --muted: #9fb0c7;
      --shadow: 0 20px 70px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", system-ui, -apple-system, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 30%, rgba(56, 242, 199, 0.12), transparent 30%),
        radial-gradient(circle at 80% 10%, rgba(109, 211, 255, 0.10), transparent 25%),
        var(--bg);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      background: rgba(7, 12, 21, 0.9);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      flex-wrap: wrap;
    }
    .brand { display: flex; align-items: center; gap: 0.75rem; }
    .logo { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 8px 25px rgba(56, 242, 199, 0.35); }
    .brand-title { font-weight: 800; letter-spacing: 0.02em; font-size: 1.1rem; }
    .brand-sub { color: var(--muted); font-size: 0.9rem; }
    .global-nav { display: flex; align-items: center; gap: 0.65rem; flex-wrap: wrap; }
    .global-nav a { padding: 0.45rem 0.65rem; border-radius: 10px; border: 1px solid transparent; color: var(--muted); font-weight: 700; }
    .global-nav a:hover { border-color: var(--border); color: var(--text); }
    .global-nav a.active { border-color: var(--accent); color: var(--text); }
    .actions { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.35rem; padding: 0.65rem 0.9rem; border-radius: 10px; border: 1px solid var(--border); color: var(--text); background: transparent; font-weight: 700; cursor: pointer; }
    .btn.primary { background: linear-gradient(120deg, var(--accent), #34d399); color: #0a1525; border: none; box-shadow: 0 12px 30px rgba(56, 242, 199, 0.35); }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .shell { max-width: 1200px; margin: 1.4rem auto 2rem; padding: 0 1.25rem; display: grid; gap: 1rem; }
    .hero { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem; box-shadow: var(--shadow); display: grid; gap: 0.6rem; }
    .muted { color: var(--muted); }
    .class-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .class-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 1rem; box-shadow: var(--shadow); display: grid; gap: 0.6rem; }
    .class-card h2 { margin: 0; }
    .pill-row { display: flex; gap: 0.35rem; flex-wrap: wrap; }
    .pill { padding: 0.3rem 0.6rem; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--muted); font-size: 0.9rem; }
    .power-list { display: grid; gap: 0.6rem; }
    .power-card { border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem; background: rgba(255,255,255,0.02); display: grid; gap: 0.4rem; }
    .power-card h3 { margin: 0; font-size: 1rem; }
    .power-card small { color: var(--muted); }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="brand-title">Origin Story Tools</div>
        <div class="brand-sub">Browse the power library</div>
      </div>
    </div>
    <nav class="global-nav">
      <a href="index.html">Home</a>
      <a href="character-builder.html">Character Builder</a>
      <a class="active" href="power-library.html">Power Library</a>
      <a href="onboarding.html">New Player Quiz</a>
      <a href="wargame.html">Wargame (separate game)</a>
      <a href="quickstart.html">Rules / How to Play</a>
    </nav>
    <div class="actions">
      <a class="btn" href="onboarding.html">Take the Quiz</a>
      <a class="btn primary" href="character-builder.html">Open Builder</a>
    </div>
  </header>

  <main class="shell">
    <section class="hero">
      <h1>Power Library</h1>
      <p class="muted">Browse every Origin Story power, grouped by class with short descriptions. Use this as a read-only reference; add powers to your character in the builder.</p>
      <div class="pill-row">
        <span class="pill">Grouped by class</span>
        <span class="pill">Action type & level noted</span>
        <span class="pill">Uses descriptions from the rule text</span>
      </div>
      <div class="actions">
        <a class="btn primary" href="character-builder.html">Open Builder</a>
        <a class="btn" href="index.html">&#8592; Back to hub</a>
      </div>
    </section>

    <section id="classContainer" class="class-grid"></section>
  </main>

  <script src="powers-data.js"></script>
  <script>
    const classDescriptions = {
      Brick: "Up-close bruisers and tanks who rely on raw power, durability, and direct action.",
      Techie: "Inventors and gadgeteers who solve problems with tools, drones, and devices.",
      Ranger: "Skilled operatives with precision movement, aim, and fieldcraft.",
      Manipulator: "Mind-benders and influence experts who twist behavior and emotions.",
      Genius: "Hyper-aware analysts with heightened senses, insight, and planning.",
      Effector: "Elemental or environmental shifters who reshape the scene around them.",
      Mutant: "Visibly altered heroes with strange biological edge cases.",
      Movement: "Mobility specialists with blinks, speed, and traversal tricks.",
      BrickPower: "Raw-force variants focused on smashing and soaking hits.",
      Misc: "Utility tricks that defy neat categories."
    };

    function markdownToPlain(md) {
      return (md || "")
        .replace(/\*\*(.+?)\*\*/g, "$1")
        .replace(/\*(.+?)\*/g, "$1")
        .replace(/<br\s*\/?>/gi, " ")
        .replace(/\s+/g, " ")
        .trim();
    }
    function stripTables(text) {
      return text
        .split(/\r?\n/)
        .filter(line => !line.trim().startsWith("|"))
        .join("\n");
    }
    function previewFromPower(power) {
      const tablePreview = (text) => {
        const lines = (text || "").split(/\r?\n/).filter(Boolean);
        const dataRows = lines.filter(l => l.includes("|") && !/^\\|\\s*-/.test(l));
        const abilities = [];
        dataRows.slice(1, 4).forEach(row => {
          const cells = row.split("|").map(c => c.trim()).filter(Boolean);
          if (cells.length >= 2) {
            const ability = cells[cells.length - 1];
            const plain = markdownToPlain(ability.replace(/<br\\s*\\/?\\s*>/gi, " "));
            if (plain) abilities.push(plain);
          }
        });
        return abilities.join(" ");
      };
      const levels = power.levels || [];
      const first = levels.sort((a, b) => a.level - b.level)[0];
      const text = first?.text || power.content || "";
      const fromTable = tablePreview(text);
      if (fromTable) {
        return fromTable.length > 320 ? fromTable.slice(0, 320) + "..." : fromTable;
      }
      const plain = markdownToPlain(stripTables(text));
      if (!plain) return "No description available.";
      return plain.length > 320 ? plain.slice(0, 320) + "..." : plain;
    }
    function inferMeta(power) {
      const className = power.path.includes("/") ? power.path.split("/")[0].replace(/\s+/g, " ").trim() : "Misc";
      const levels = power.levels.map(l => l.level).filter(Boolean);
      const minLevel = levels.length ? Math.min(...levels) : 1;
      const text = (power.content || "").toLowerCase();
      const tags = new Set();
      if (/\b(damage|attack|hit|blast|strike|deal)\b/.test(text)) tags.add("Attack");
      if (/\b(armor|resist|shield|hp|health|immunity|regeneration)\b/.test(text)) tags.add("Defense");
      if (/\b(teleport|move|speed|control|summon|craft|build|utility|support|drone)\b/.test(text)) tags.add("Utility");
      let action = "Standard";
      if (/reaction/.test(text)) action = "Reaction";
      else if (/\bmove\b|\bmovement\b|\bfree action\b|\bbonus action\b/.test(text)) action = "Move";
      return { className: className || "Misc", minLevel, tags: Array.from(tags), action };
    }

    function render() {
      if (typeof EMBEDDED_POWERS === "undefined") {
        document.getElementById("classContainer").textContent = "Power data missing. Ensure powers-data.js is present.";
        return;
      }
      const byClass = new Map();
      EMBEDDED_POWERS.forEach(raw => {
        const content = typeof raw.content === "string" ? raw.content : (raw.content?.value ?? "");
        const power = {
          name: raw.name,
          path: (raw.path || "").replace(/\\\\/g, "/").replace(/\\/g, "/"),
          content,
          levels: Array.isArray(raw.levels) ? raw.levels : []
        };
        power.meta = inferMeta(power);
        if (!byClass.has(power.meta.className)) byClass.set(power.meta.className, []);
        byClass.get(power.meta.className).push(power);
      });

      const container = document.getElementById("classContainer");
      container.innerHTML = "";
      Array.from(byClass.keys()).sort().forEach(cls => {
        const powers = byClass.get(cls).sort((a, b) => a.name.localeCompare(b.name));
        const card = document.createElement("article");
        card.className = "class-card";
        const desc = classDescriptions[cls] || "A mix of techniques that share a loose theme.";
        card.innerHTML = `
          <div>
            <h2>${cls}</h2>
            <div class="muted">${desc}</div>
          </div>
          <div class="power-list"></div>
        `;
        const list = card.querySelector(".power-list");
        powers.forEach(power => {
          const p = document.createElement("div");
          p.className = "power-card";
          p.innerHTML = `
            <h3>${power.name}</h3>
            <small>Lv ${power.meta.minLevel} • ${power.meta.action} action • ${power.meta.tags.join(", ") || "General"}</small>
            <div class="muted">${previewFromPower(power)}</div>
          `;
          list.appendChild(p);
        });
        container.appendChild(card);
      });
    }

    render();
  </script>
</body>
</html>
