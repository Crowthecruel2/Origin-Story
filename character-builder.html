
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Origin Story Character Builder</title>
  <style>
    :root {
      --bg: #050910;
      --panel: #0d1624;
      --card: #0f1c2d;
      --border: #233449;
      --accent: #38f2c7;
      --accent-2: #6dd3ff;
      --text: #e6ebf5;
      --muted: #9fb0c7;
      --danger: #f87171;
      --warning: #fbbf24;
      --success: #34d399;
      --shadow: 0 20px 70px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", system-ui, -apple-system, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 30%, rgba(56, 242, 199, 0.12), transparent 30%),
        radial-gradient(circle at 80% 10%, rgba(109, 211, 255, 0.10), transparent 25%),
        var(--bg);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.85rem 1.6rem;
      background: rgba(7, 12, 21, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .brand {
      display: flex;
      gap: 0.7rem;
      align-items: center;
    }
    .brand .logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 8px 25px rgba(56, 242, 199, 0.45);
    }
    .brand .eyebrow { color: var(--muted); font-size: 0.8rem; letter-spacing: 0.08em; }
    .brand .title { font-weight: 800; font-size: 1.25rem; letter-spacing: 0.02em; }
    .global-nav { display: flex; gap: 0.65rem; flex-wrap: wrap; align-items: center; }
    .global-nav a {
      padding: 0.45rem 0.7rem;
      border-radius: 10px;
      border: 1px solid transparent;
      color: var(--muted);
      font-weight: 700;
    }
    .global-nav a:hover { border-color: var(--border); color: var(--text); }
    .global-nav a.active { border-color: var(--accent); color: var(--text); }
    .top-actions {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      font-size: 0.9rem;
    }
    .ghost-btn, .primary-btn, .secondary-btn, .chip {
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid var(--border);
      color: var(--text);
      background: transparent;
      padding: 0.55rem 0.85rem;
      font-weight: 700;
      transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }
    .ghost-btn:hover { border-color: var(--accent); color: var(--accent); }
    .primary-btn {
      background: linear-gradient(120deg, var(--accent), #34d399);
      color: #0a1525;
      border: none;
      box-shadow: 0 12px 30px rgba(56, 242, 199, 0.35);
    }
    .primary-btn:hover { transform: translateY(-1px); }
    .secondary-btn:hover { border-color: var(--accent-2); color: var(--accent-2); }
    .app-shell {
      max-width: 1400px;
      margin: 1.4rem auto 2rem;
      padding: 0 1.3rem 1.3rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .summary-card {
      background: linear-gradient(135deg, rgba(56,242,199,0.12), rgba(109,211,255,0.10));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem 1.25rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .summary-title { font-weight: 800; font-size: 1.1rem; letter-spacing: 0.02em; }
    .summary-muted { color: var(--muted); }
    .summary-actions { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; }
    .badge {
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      padding: 0.35rem 0.55rem;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.9rem;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.05fr 1.1fr;
      gap: 1rem;
      align-items: start;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1rem;
      box-shadow: var(--shadow);
      display: grid;
      gap: 0.8rem;
    }
    .section-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem 0.9rem;
      background: rgba(255,255,255,0.02);
      display: grid;
      gap: 0.6rem;
    }
    .section-heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      font-weight: 800;
      letter-spacing: 0.01em;
    }
    .section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 800;
      letter-spacing: 0.01em;
    }
    .section-title small { color: var(--muted); font-weight: 600; }
    .back-link {
      color: var(--accent);
      font-weight: 700;
      text-decoration: none;
    }
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: 0.35rem;
      cursor: help;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      color: var(--muted);
      font-weight: 700;
      font-size: 0.9rem;
    }
    input, textarea, select {
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.6rem 0.65rem;
      color: var(--text);
      font-size: 1rem;
    }
    input:focus, textarea:focus, select:focus { outline: 1px solid var(--accent); border-color: var(--accent); }
    .flex-row { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.65rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; }
    .stats-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .stats-columns h4 { margin: 0 0 0.35rem; color: var(--muted); font-weight: 700; letter-spacing: 0.02em; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; }
    .derived-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem;
      position: relative;
    }
    .stat-card strong { font-size: 1.3rem; color: var(--accent); }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .tip { border-bottom: 1px dashed var(--border); cursor: help; }
    .banner {
      border-radius: 12px;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      background: rgba(248, 113, 113, 0.08);
      color: #fecdd3;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      box-shadow: var(--shadow);
    }
    .banner.success {
      background: rgba(52, 211, 153, 0.1);
      color: #bbf7d0;
      border-color: #34d399;
    }
    .banner.hidden { display: none; }
    .powers-zone {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 0.8rem;
      background: rgba(56, 242, 199, 0.03);
      min-height: 200px;
      transition: border-color 0.12s ease, background 0.12s ease;
    }
    .powers-zone.drag-over {
      border-color: var(--accent);
      background: rgba(56, 242, 199, 0.1);
    }
    .power-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem;
      display: grid;
      gap: 0.35rem;
      cursor: grab;
      transition: transform 0.12s ease, border-color 0.12s ease;
    }
    .power-card:hover { border-color: var(--accent); transform: translateY(-1px); }
    .power-card header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }
    .power-card .caret {
      font-size: 1rem;
      color: var(--muted);
      transition: transform 0.12s ease;
    }
    .power-card .caret.open {
      transform: rotate(90deg);
    }
    .power-levels {
      display: grid;
      gap: 0.45rem;
      margin-top: 0.35rem;
    }
    .power-levels.collapsed { display: none; }
    .pill-row { display: flex; gap: 0.35rem; flex-wrap: wrap; }
    .pill-tag {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 999px;
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
    }
    .library-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 0.65rem;
      max-height: 60vh;
      overflow: auto;
      padding-right: 0.25rem;
    }
    .detail-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.85rem;
      display: grid;
      gap: 0.5rem;
    }
    .detail-panel.hidden { display: none; }
    .inventory-list > div {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 10px;
      padding: 0.65rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
    }
    .chip {
      padding: 0.45rem 0.6rem;
      border-radius: 999px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .chip.active { background: rgba(56, 242, 199, 0.15); border-color: var(--accent); color: var(--text); }
    .helper-text { color: var(--muted); font-size: 0.9rem; }
    .status-line { font-weight: 700; display: flex; align-items: center; gap: 0.4rem; }
    .status-good { color: var(--success); }
    .status-warn { color: var(--warning); }
    .danger { color: var(--danger); }
    details.advanced {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.6rem 0.7rem;
      background: rgba(255,255,255,0.03);
    }
    details.advanced summary {
      cursor: pointer;
      font-weight: 700;
      color: var(--muted);
      list-style: none;
    }
    details.advanced summary::-webkit-details-marker { display: none; }
    details.advanced[open] summary { color: var(--text); }
    .invalid input { border-color: var(--danger); }
    .coachmark {
      position: relative;
    }
    .coachmark .hint {
      display: none;
      position: absolute;
      top: -12px;
      right: 0;
      background: rgba(109,211,255,0.15);
      border: 1px solid var(--accent-2);
      color: var(--text);
      padding: 0.35rem 0.5rem;
      border-radius: 8px;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    body.tour .coachmark .hint { display: inline-flex; }
    body.tour .powers-zone { box-shadow: 0 0 0 2px var(--accent-2); }
    .tooltip {
      position: relative;
      cursor: help;
    }
    .tooltip::after {
      content: attr(data-tip);
      position: absolute;
      left: 0;
      top: 110%;
      white-space: nowrap;
      background: #0a1321;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.35rem 0.5rem;
      color: var(--text);
      font-size: 0.85rem;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-4px);
      transition: opacity 0.12s ease, transform 0.12s ease;
      z-index: 5;
    }
    .tooltip:hover::after { opacity: 1; transform: translateY(0); }
    @media (max-width: 1180px) {
      .grid { grid-template-columns: 1fr; }
      .library-list { max-height: none; }
      .topbar { position: static; flex-direction: column; align-items: flex-start; }
    }
    @media (max-width: 900px) {
      body { padding: 0; }
      .app-shell { padding: 0.8rem; }
      .summary-card { flex-direction: column; align-items: flex-start; }
      .summary-actions { width: 100%; }
    .nav-links { width: 100%; }
    .top-actions { width: 100%; justify-content: flex-start; }
      .stats-columns { grid-template-columns: 1fr; }
      .library-list { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    }
    @media print {
      body { background: #fff; color: #000; }
      .topbar, .print-hide, #libraryPanel { display: none !important; }
      .grid { grid-template-columns: 1fr; }
      .panel { box-shadow: none; border: 1px solid #ccc; background: #fff; }
      .powers-zone, .power-card, .inventory-list > div { border-color: #aaa; background: #fff; }
      .banner { display: none !important; }
      .power-levels.collapsed { display: grid !important; }
      .unowned-level { display: none !important; }
      .power-card { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <header class="topbar print-hide">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="eyebrow">Origin Story Tools</div>
        <div class="title">Character Builder</div>
      </div>
    </div>
    <nav class="global-nav">
      <a href="index.html">Home</a>
      <a class="active" href="character-builder.html">Character Builder</a>
      <a href="lore.html">City Lore</a>
      <a href="onboarding.html">New Player Quiz</a>
      <a href="wargame.html">Wargame (separate game)</a>
      <a href="quickstart.html">Rules / How to Play</a>
    </nav>
    <div class="top-actions">
      <button id="startTourLink" class="ghost-btn" type="button">New Player? Start Here</button>
      <div class="pill" id="saveStamp">Last saved: never</div>
    </div>
  </header>

  <main class="app-shell">
    <a class="back-link print-hide" href="index.html">&#8592; Back to Origin Story Hub</a>
    <div class="summary-card">
      <div>
        <div class="summary-title">Live character summary <span class="muted">(updates as you edit)</span></div>
        <div class="summary-muted" id="summaryText">Level 1 | Health 10 | Power Points 0/1 | Powers: 0 | Inventory items: 0</div>
      </div>
      <div class="summary-actions print-hide">
        <span class="badge" id="statBudgetBadge">Stat budget: 7 base + 2/level</span>
        <button class="primary-btn" id="quickSave">Quick Save</button>
        <button class="secondary-btn" id="quickLoad">Load Last</button>
        <button class="secondary-btn" id="printCharacter">Print / PDF</button>
      </div>
    </div>
    <div id="sampleBanner" class="banner success hidden print-hide">Loaded a sample Level 1 Street Brawler. Tweak anything you like.</div>
    <div id="ppWarning" class="banner hidden print-hide"></div>
    <div id="statWarning" class="banner hidden print-hide"></div>

    <div class="grid">
      <section class="panel" aria-label="Character information">
        <div class="section-card">
          <div class="section-heading">Character Info</div>
          <div class="grid-2">
            <label>Character Name
              <input id="name" placeholder="Name">
            </label>
            <label>Concept / Notes
              <input id="concept" placeholder="Short concept or role">
            </label>
          </div>
        </div>

        <div class="section-card">
          <div class="section-heading">Stats</div>
          <div class="stats-columns coachmark" id="statsGroup">
            <div>
              <h4>Base</h4>
              <div class="stats-grid">
                <label>Reflex (base) <span class="help-icon tooltip" data-tip="Speed, initiative, and quick moves.">?</span>
                  <input type="number" id="reflexBase" value="0" step="1">
                </label>
                <label>Strength (base) <span class="help-icon tooltip" data-tip="Force, lifting, melee damage.">?</span>
                  <input type="number" id="strengthBase" value="0" step="1">
                </label>
                <label>Smarts (base) <span class="help-icon tooltip" data-tip="Knowledge, perception, and planning.">?</span>
                  <input type="number" id="smartsBase" value="0" step="1">
                </label>
                <label>Social (base) <span class="help-icon tooltip" data-tip="Influence, negotiations, and presence.">?</span>
                  <input type="number" id="socialBase" value="0" step="1">
                </label>
                <label>Durability (base) <span class="help-icon tooltip" data-tip="Toughness, endurance, and grit.">?</span>
                  <input type="number" id="durabilityBase" value="0" step="1">
                </label>
              </div>
            </div>
            <div>
              <h4>Mods</h4>
              <div class="stats-grid">
                <label>Reflex (mod)
                  <input type="number" id="reflexMod" value="0" step="1">
                </label>
                <label>Strength (mod)
                  <input type="number" id="strengthMod" value="0" step="1">
                </label>
                <label>Smarts (mod)
                  <input type="number" id="smartsMod" value="0" step="1">
                </label>
                <label>Social (mod)
                  <input type="number" id="socialMod" value="0" step="1">
                </label>
                <label>Durability (mod)
                  <input type="number" id="durabilityMod" value="0" step="1">
                </label>
              </div>
            </div>
          </div>
          <div id="statBudgetStatus" class="status-line status-good">You are within your stat budget.</div>
        </div>

        <div class="section-card">
          <div class="section-heading">Derived Stats</div>
          <div class="derived-cards">
            <label>Level
              <input type="number" id="level" value="1" min="1" step="1">
            </label>
            <div class="stat-card tooltip" data-tip="10 + Durability x Level (core rule)">
              <div class="muted">Health</div>
              <strong id="health">10</strong>
              <div class="muted">Auto-updates with Level & Durability</div>
            </div>
            <div class="stat-card tooltip" data-tip="Power Points equal your Level. Each power level costs PP.">
              <div class="muted">Power Points</div>
              <strong id="powerPoints">1 / 1</strong>
              <div class="muted" id="powerPointsDetail">1 remaining (spent 0)</div>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-heading">Advanced: Stat budget (house rules)</div>
          <details class="advanced" id="advancedBudget">
            <summary>Adjust stat budget</summary>
            <div class="grid-2" style="margin-top:0.6rem;">
              <label>Base pool
                <input type="number" id="statBasePool" value="7" min="0">
              </label>
              <label>Per-level gain
                <input type="number" id="statPerLevel" value="2" min="0">
              </label>
            </div>
            <div class="helper-text">Budget = Base pool + Per-level gain x (Level - 1). Total points = sum of base + modifiers.</div>
          </details>
        </div>

        <div class="section-card">
          <div class="section-heading">Save & Export</div>
          <div class="grid-2">
            <div class="coachmark" id="saveOptions">
              <span class="hint">Fast local save</span>
              <div class="flex-row">
                <button class="primary-btn" id="quickSaveInline">Quick Save</button>
                <button class="secondary-btn" id="quickLoadInline">Load Last Character</button>
              </div>
              <div class="helper-text">Quick Save keeps data in your browser (localStorage). Use Load Last to restore.</div>
            </div>
            <div>
              <div class="flex-row">
                <button class="secondary-btn" id="selectCharacterFolder">Export character to file</button>
                <button class="secondary-btn" id="loadCharacter">Import character from file</button>
              </div>
              <div class="helper-text" id="characterFolderHint">No folder selected</div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" aria-label="Character sheet" id="sheetPanel">
        <div class="section-card">
          <div class="section-heading">Character Powers <small class="muted">Drag from the right or click to remove</small></div>
          <div id="characterPowers" class="powers-zone coachmark" aria-label="Character powers drop zone">
            <span class="hint">Drop powers here</span>
          </div>
        </div>

        <div class="section-card">
          <div class="section-heading">Inventory</div>
          <div class="flex-row print-hide">
            <input id="invName" placeholder="Item name" style="min-width:180px;">
            <input id="invQty" type="number" min="1" value="1" style="width:90px;">
            <input id="invNotes" placeholder="Notes/effects" style="flex:1; min-width:200px;">
            <button class="secondary-btn" id="addItem">Add</button>
          </div>
          <div id="inventoryList" class="inventory-list"></div>
        </div>

        <div class="section-card">
          <div class="section-heading">Character Background</div>
          <textarea id="backgroundText" rows="6" placeholder="Backstory, affiliations, notes" style="width:100%; resize: vertical;"></textarea>
        </div>

        <div class="section-card" aria-label="Power library" id="libraryPanel">
          <div class="section-heading">Power Library <small class="muted">Search, filter, click for details</small></div>
          <div class="grid-2">
            <input id="search" placeholder="Search powers or text..." aria-label="Search powers">
            <button class="secondary-btn" id="loadPowers">Reload power data</button>
          </div>
          <div class="grid-3">
            <label>Class
              <select id="filterClass"></select>
            </label>
            <label>Level
              <select id="filterLevel">
                <option value="all">Any</option>
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3</option>
                <option value="4">Level 4+</option>
              </select>
            </label>
            <label>Category
              <select id="filterCategory">
                <option value="all">Any</option>
                <option value="Attack">Attack</option>
                <option value="Defense">Defense</option>
                <option value="Utility">Utility</option>
              </select>
            </label>
            <label>Action Type
              <select id="filterAction">
                <option value="all">Any</option>
                <option value="Standard">Standard</option>
                <option value="Move">Move</option>
                <option value="Reaction">Reaction</option>
              </select>
            </label>
          </div>
          <div class="flex-row print-hide">
            <span class="helper-text">Quick filters:</span>
            <button class="chip" data-quick="level1">Show only Level 1</button>
            <button class="chip" data-quick="level2">Level 2+</button>
            <button class="chip" data-quick="classBrick">Brick</button>
            <button class="chip" data-quick="classTechie">Techie</button>
            <button class="chip" data-quick="classRanger">Ranger</button>
            <button class="chip" data-quick="clear">Clear</button>
          </div>
          <div id="powerList" class="library-list" aria-label="Available powers"></div>
          <div class="section-card hidden" id="detailWrapper">
            <div id="powerDetail" class="detail-panel">
              <div class="section-title">Power details</div>
              <div id="detailTitle" style="font-weight:800;"></div>
              <div class="muted" id="detailPath"></div>
              <div class="pill-row" id="detailTags"></div>
              <div id="detailBody" class="muted" style="white-space:pre-wrap;"></div>
              <div class="flex-row">
                <button class="primary-btn" id="addFromDetail">Add to character</button>
                <button class="ghost-btn" id="closeDetail">Close</button>
              </div>
            </div>
          </div>
        </div>
      </section>
      </section>
    </div>
  </main>

  <script src="powers-data.js"></script>
  <script>
    const powerLibrary = [];
    const chosenPowers = new Map();
    const inventory = [];
    const LOCAL_KEY = "origin-story-character-quick-save";
    const CATEGORY_DESCRIPTIONS = {
      Brick: "Powers that allow for supernatural strength or durability. Built like brick houses.",
      BrickPower: "Powers that allow for supernatural strength or durability. Built like brick houses.",
      Effector: "Powers that alter the environment or elements around the user.",
      Genius: "Powers that enhance intelligence, senses, or skill to supernatural levels.",
      Manipulator: "Powers that influence minds, actions, or control others.",
      Mutant: "Powers that visibly change the user's anatomy or form.",
      Ranger: "Powers that grant exceptional skills or impossible techniques.",
      Techie: "Powers enabling creation and use of super-tech.",
      Movement: "Mobility focused techniques.",
      Misc: "Uncategorized powers."
    };

    const elements = {
      level: document.getElementById("level"),
      health: document.getElementById("health"),
      powerPoints: document.getElementById("powerPoints"),
      powerPointsDetail: document.getElementById("powerPointsDetail"),
      powerList: document.getElementById("powerList"),
      characterPowers: document.getElementById("characterPowers"),
      search: document.getElementById("search"),
      loadBtn: document.getElementById("loadPowers"),
      selectCharacterFolder: document.getElementById("selectCharacterFolder"),
      loadCharacter: document.getElementById("loadCharacter"),
      characterFolderHint: document.getElementById("characterFolderHint"),
      invName: document.getElementById("invName"),
      invQty: document.getElementById("invQty"),
      invNotes: document.getElementById("invNotes"),
      addItem: document.getElementById("addItem"),
      inventoryList: document.getElementById("inventoryList"),
      printCharacter: document.getElementById("printCharacter"),
      reflexBase: document.getElementById("reflexBase"),
      reflexMod: document.getElementById("reflexMod"),
      strengthBase: document.getElementById("strengthBase"),
      strengthMod: document.getElementById("strengthMod"),
      smartsBase: document.getElementById("smartsBase"),
      smartsMod: document.getElementById("smartsMod"),
      socialBase: document.getElementById("socialBase"),
      socialMod: document.getElementById("socialMod"),
      durabilityBase: document.getElementById("durabilityBase"),
      durabilityMod: document.getElementById("durabilityMod"),
      statBasePool: document.getElementById("statBasePool"),
      statPerLevel: document.getElementById("statPerLevel"),
      summaryText: document.getElementById("summaryText"),
      statBudgetBadge: document.getElementById("statBudgetBadge"),
      statBudgetStatus: document.getElementById("statBudgetStatus"),
      ppWarning: document.getElementById("ppWarning"),
      statWarning: document.getElementById("statWarning"),
      saveStamp: document.getElementById("saveStamp"),
      quickSave: document.getElementById("quickSave"),
      quickLoad: document.getElementById("quickLoad"),
      quickSaveInline: document.getElementById("quickSaveInline"),
      quickLoadInline: document.getElementById("quickLoadInline"),
      filterClass: document.getElementById("filterClass"),
      filterLevel: document.getElementById("filterLevel"),
      filterCategory: document.getElementById("filterCategory"),
      filterAction: document.getElementById("filterAction"),
      powerDetail: document.getElementById("powerDetail"),
      detailTitle: document.getElementById("detailTitle"),
      detailPath: document.getElementById("detailPath"),
      detailTags: document.getElementById("detailTags"),
      detailBody: document.getElementById("detailBody"),
      addFromDetail: document.getElementById("addFromDetail"),
      closeDetail: document.getElementById("closeDetail"),
      backgroundText: document.getElementById("backgroundText"),
      sampleBanner: document.getElementById("sampleBanner"),
      startTourLink: document.getElementById("startTourLink"),
      detailWrapper: document.getElementById("detailWrapper"),
    };

    const filters = { search: "", class: "all", level: "all", category: "all", action: "all" };
    let selectedPower = null;
    let characterDirHandle = null;
    let lastSavedAt = null;
    let dirty = false;
    let filtersTouched = false;
    let appliedLevel1Default = false;

    function setDirty() {
      dirty = true;
      elements.saveStamp.textContent = `Last saved: unsaved changes`;
      if (elements.sampleBanner) elements.sampleBanner.classList.add("hidden");
    }
    function getLevel() {
      return Number(elements.level.value) || 0;
    }

    function statBudget() {
      const base = Number(elements.statBasePool.value) || 0;
      const per = Number(elements.statPerLevel.value) || 0;
      const lvl = Math.max(getLevel(), 1);
      return Math.max(0, base + per * (lvl - 1));
    }

    function totalStats() {
      const vals = [
        elements.reflexBase, elements.strengthBase, elements.smartsBase, elements.socialBase, elements.durabilityBase,
        elements.reflexMod, elements.strengthMod, elements.smartsMod, elements.socialMod, elements.durabilityMod,
      ];
      return vals.reduce((sum, el) => sum + (Number(el.value) || 0), 0);
    }

    function updateDerived() {
      const level = getLevel();
      const durability = Number(elements.durabilityBase.value || 0) + Number(elements.durabilityMod.value || 0);
      elements.health.textContent = 10 + durability * level;
      updatePointsDisplay();
      updateSummary();
      validateStats();
    }

    function levelCost(power, levelNumber) {
      const levelObj = power.levels.find(l => l.level === levelNumber);
      return levelObj && !Number.isNaN(Number(levelObj.cost)) ? Number(levelObj.cost) : 1;
    }

    function computeSpent() {
      let spent = 0;
      for (const power of chosenPowers.values()) {
        const purchased = power.purchased ? Array.from(power.purchased) : [];
        purchased.forEach(idx => {
          const lv = power.levels[idx];
          if (lv) spent += levelCost(power, lv.level);
        });
      }
      return spent;
    }

    function pointsSummary() {
      const total = Math.max(getLevel(), 0);
      const spent = computeSpent();
      const available = Math.max(total - spent, 0);
      return { total, spent, available };
    }

    function updatePointsDisplay() {
      const { total, spent, available } = pointsSummary();
      elements.powerPoints.textContent = `${spent}/${total}`;
      elements.powerPointsDetail.textContent = `${available} remaining`;
      updatePPWarning();
    }

    function updateSummary() {
      const { total, spent } = pointsSummary();
      const invCount = inventory.length;
      const powerCount = chosenPowers.size;
      const summary = `Level ${getLevel()} | Health ${elements.health.textContent} | Power Points ${spent}/${total} | Powers: ${powerCount} | Inventory items: ${invCount}`;
      elements.summaryText.textContent = summary;
      elements.statBudgetBadge.textContent = `Stat budget: ${elements.statBasePool.value || 0} base + ${elements.statPerLevel.value || 0}/level (spent ${totalStats()})`;
    }

    function updatePPWarning() {
      const { total, spent } = pointsSummary();
      const over = spent - total;
      if (over > 0) {
        elements.ppWarning.textContent = `You've spent ${over} more PP than allowed for Level ${getLevel()}. Trim powers or level up.`;
        elements.ppWarning.classList.remove("hidden");
      } else {
        elements.ppWarning.classList.add("hidden");
      }
    }

    function validateStats() {
      const budget = statBudget();
      const spent = totalStats();
      const group = document.getElementById("statsGroup");
      const statusLine = elements.statBudgetStatus;
      if (statusLine) {
        statusLine.classList.remove("status-good", "status-warn");
      }
      if (spent > budget) {
        elements.statWarning.textContent = `Stats exceed budget by ${spent - budget}. Budget = ${budget}, spent = ${spent}.`;
        elements.statWarning.classList.remove("hidden");
        group.classList.add("invalid");
        if (statusLine) {
          statusLine.textContent = `(!) You are ${spent - budget} over your stat budget (${spent}/${budget}).`;
          statusLine.classList.add("status-warn");
        }
      } else {
        elements.statWarning.classList.add("hidden");
        group.classList.remove("invalid");
        if (statusLine) {
          statusLine.textContent = `(OK) You have spent ${spent} of ${budget} stat points.`;
          statusLine.classList.add("status-good");
        }
      }
    }

    function renderCharacterPowers() {
      elements.characterPowers.innerHTML = "";
      if (chosenPowers.size === 0) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No powers yet. Drag cards from the library.";
        elements.characterPowers.appendChild(empty);
        updatePointsDisplay();
        updateSummary();
        return;
      }

      for (const power of chosenPowers.values()) {
        const purchased = power.purchased ? new Set(power.purchased) : new Set();
        const maxPurchasedLevel = Math.max(0, ...Array.from(purchased).map(i => power.levels[i]?.level || 0));
        const card = document.createElement("article");
        card.className = "power-card";
        card.style.cursor = "default";

        const header = document.createElement("header");
        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "0.4rem";
        const caret = document.createElement("span");
        caret.className = "caret";
        caret.textContent = "▸";
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = power.name;
        left.appendChild(caret);
        left.appendChild(title);
        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "0.35rem";
        const detailBtn = document.createElement("button");
        detailBtn.type = "button";
        detailBtn.className = "ghost-btn";
        detailBtn.style.padding = "0.35rem 0.6rem";
        detailBtn.textContent = "View";
        detailBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          showPowerDetail(power);
        });
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.title = "Remove power";
        removeBtn.className = "ghost-btn";
        removeBtn.style.color = "var(--danger)";
        removeBtn.style.padding = "0.35rem 0.6rem";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          chosenPowers.delete(power.path);
          setDirty();
          renderCharacterPowers();
          updateSummary();
        });
        right.appendChild(detailBtn);
        right.appendChild(removeBtn);
        header.appendChild(left);
        header.appendChild(right);
        card.appendChild(header);

        const levelsWrapper = document.createElement("div");
        levelsWrapper.className = "power-levels collapsed";

        power.levels.forEach((lv, idx) => {
          const isPurchased = purchased.has(idx);
          const row = document.createElement("div");
          row.style.borderTop = "1px solid var(--border)";
          row.style.paddingTop = "0.5rem";
          const costText = `Cost ${levelCost(power, lv.level)} PP`;
          if (isPurchased) {
            row.classList.add("owned-level");
            row.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:600;color:var(--accent);">Level ${lv.level} (owned)</div>
                <div class="muted">${costText}</div>
              </div>
              <div class="muted" style="white-space:pre-wrap;">${formatMarkdown(lv.text)}</div>
            `;
          } else {
            row.classList.add("unowned-level");
            const { available } = pointsSummary();
            const canBuy = lv.level === 1 || lv.level <= maxPurchasedLevel + 1;
            const buyBtn = document.createElement("button");
            buyBtn.className = "secondary-btn";
            const desc = levelDescriptor(lv);
            buyBtn.textContent = `Buy Level ${lv.level}${desc ? ": " + desc : ""} (${costText})`;
            buyBtn.disabled = !canBuy;
            buyBtn.addEventListener("click", () => {
              const { available } = pointsSummary();
              const cost = levelCost(power, lv.level);
              if (!canBuy) {
                alert("You need previous levels first.");
                return;
              }
              if (available < cost) {
                alert(`Not enough power points. Need ${cost}, have ${available}.`);
                return;
              }
              purchased.add(idx);
              power.purchased = purchased;
              chosenPowers.set(power.path, power);
              setDirty();
              renderCharacterPowers();
              updateSummary();
            });
            row.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
                <div>
                  <div style="font-weight:600;">Level ${lv.level}</div>
                  <div class="muted">${costText}${canBuy ? "" : " - Locked until previous level"}</div>
                </div>
              </div>
            `;
            row.appendChild(buyBtn);
          }
          levelsWrapper.appendChild(row);
        });
        card.appendChild(levelsWrapper);

        header.addEventListener("click", () => {
          const isCollapsed = levelsWrapper.classList.toggle("collapsed");
          caret.classList.toggle("open", !isCollapsed);
        });
        elements.characterPowers.appendChild(card);
      }
      updatePointsDisplay();
      updateSummary();
    }

    function renderInventory() {
      elements.inventoryList.innerHTML = "";
      if (inventory.length === 0) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No items. Add one above.";
        elements.inventoryList.appendChild(empty);
        return;
      }
      inventory.forEach((item, idx) => {
        const row = document.createElement("div");
        const left = document.createElement("div");
        left.innerHTML = `<strong>${item.name}</strong> x${item.qty}${item.notes ? " - " + item.notes : ""}`;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.title = "Remove item";
        btn.textContent = "Remove";
        btn.className = "ghost-btn";
        btn.style.padding = "0.25rem 0.5rem";
        btn.addEventListener("click", () => {
          inventory.splice(idx, 1);
          setDirty();
          renderInventory();
          updateSummary();
        });
        row.appendChild(left);
        row.appendChild(btn);
        elements.inventoryList.appendChild(row);
      });
    }
    function inferMeta(power) {
      const className = power.path.includes("/") ? power.path.split("/")[0].replace(/\s+/g, " ").trim() : "Misc";
      const levels = power.levels.map(l => l.level).filter(Boolean);
      const minLevel = levels.length ? Math.min(...levels) : 1;
      const text = (power.content || "").toLowerCase();
      const tags = new Set();

      if (/\b(damage|attack|hit|blast|strike|deal)\b/.test(text)) tags.add("Attack");
      if (/\b(armor|resist|shield|hp|health|immunity|regeneration)\b/.test(text)) tags.add("Defense");
      if (/\b(teleport|move|speed|control|summon|craft|build|utility|support|drone)\b/.test(text)) tags.add("Utility");

      let action = "Standard";
      if (/reaction/.test(text)) action = "Reaction";
      else if (/\bmove\b|\bmovement\b|\bfree action\b|\bbonus action\b/.test(text)) action = "Move";

      return { className: className || "Misc", minLevel, tags: Array.from(tags), action };
    }

    function markFiltersTouched() {
      filtersTouched = true;
    }

    function maybeApplyLevelOneFilter() {
      if (appliedLevel1Default || filtersTouched) return;
      if (getLevel() <= 1) {
        filters.level = "1";
        elements.filterLevel.value = "1";
        const levelChip = document.querySelector('.chip[data-quick="level1"]');
        if (levelChip) {
          document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
          levelChip.classList.add("active");
        }
        appliedLevel1Default = true;
        applyFilters();
      }
    }

    function renderPowerLibrary(list) {
      elements.powerList.innerHTML = "";
      if (!list || list.length === 0) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No powers to display. Adjust filters or reload.";
        elements.powerList.appendChild(empty);
        return;
      }

      list
        .slice()
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(power => renderPowerCard(power));
    }

    function renderPowerCard(power) {
      const card = document.createElement("article");
      card.className = "power-card";
      card.draggable = true;
      card.dataset.powerPath = power.path;

      const header = document.createElement("header");
      const title = document.createElement("div");
      title.textContent = power.name;
      title.style.fontWeight = "700";
      header.appendChild(title);

      const classTag = document.createElement("span");
      classTag.className = "pill-tag";
      classTag.textContent = power.meta.className;
      header.appendChild(classTag);
      card.appendChild(header);

      const preview = document.createElement("div");
      preview.className = "muted";
      preview.textContent = previewFromPower(power);
      card.appendChild(preview);

      const tagsRow = document.createElement("div");
      tagsRow.className = "pill-row";
      tagsRow.innerHTML = `
        <span class="pill-tag">Lv ${power.meta.minLevel}</span>
        <span class="pill-tag">${power.meta.action} action</span>
        ${power.meta.tags.map(t => `<span class="pill-tag">${t}</span>`).join("")}
      `;
      card.appendChild(tagsRow);

      card.addEventListener("dragstart", (evt) => {
        evt.dataTransfer.setData("text/plain", power.path);
      });
      card.addEventListener("dblclick", () => addPowerToCharacter(power));
      card.addEventListener("click", () => showPowerDetail(power));
      elements.powerList.appendChild(card);
    }

    function showPowerDetail(power) {
      selectedPower = power;
      elements.detailTitle.textContent = power.name;
      elements.detailPath.textContent = power.path || "";
      elements.detailBody.innerHTML = formatMarkdown(power.content || "");
      elements.detailTags.innerHTML = "";
      const pieces = [
        `Class: ${power.meta.className}`,
        `Lv ${power.meta.minLevel}`,
        `${power.meta.action} action`,
        ...power.meta.tags
      ];
      pieces.forEach(tag => {
        const span = document.createElement("span");
        span.className = "pill-tag";
        span.textContent = tag;
        elements.detailTags.appendChild(span);
      });
      if (elements.detailWrapper) elements.detailWrapper.classList.remove("hidden");
      elements.powerDetail.classList.remove("hidden");
    }

    elements.characterPowers.addEventListener("dragover", (evt) => {
      evt.preventDefault();
      elements.characterPowers.classList.add("drag-over");
    });
    elements.characterPowers.addEventListener("dragleave", () => {
      elements.characterPowers.classList.remove("drag-over");
    });
    elements.characterPowers.addEventListener("drop", (evt) => {
      evt.preventDefault();
      elements.characterPowers.classList.remove("drag-over");
      const path = evt.dataTransfer.getData("text/plain");
      const power = powerLibrary.find(p => p.path === path);
      if (power) {
        addPowerToCharacter(power);
      }
    });

    function applyFilters() {
      let list = powerLibrary.slice();
      if (filters.search) {
        const term = filters.search.toLowerCase();
        list = list.filter(p =>
          p.name.toLowerCase().includes(term) ||
          p.path.toLowerCase().includes(term) ||
          p.content.toLowerCase().includes(term)
        );
      }
      if (filters.class !== "all") {
        list = list.filter(p => p.meta.className.toLowerCase().includes(filters.class.toLowerCase()));
      }
      if (filters.level !== "all") {
        if (filters.level === "4") {
          list = list.filter(p => p.meta.minLevel >= 4);
        } else if (filters.level === "2plus") {
          list = list.filter(p => p.meta.minLevel >= 2);
        } else {
          const lvl = Number(filters.level);
          list = list.filter(p => p.levels.some(l => Number(l.level) === lvl));
        }
      }
      if (filters.category !== "all") {
        list = list.filter(p => p.meta.tags.includes(filters.category));
      }
      if (filters.action !== "all") {
        list = list.filter(p => p.meta.action === filters.action);
      }
      renderPowerLibrary(list);
    }

    function hydrateFilters() {
      const classes = Array.from(new Set(powerLibrary.map(p => p.meta.className))).sort((a, b) => a.localeCompare(b));
      elements.filterClass.innerHTML = `<option value="all">Any</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join("");
    }

    function hydrateFromEmbedded() {
      if (typeof EMBEDDED_POWERS === "undefined") {
        alert("Missing embedded powers data. Ensure powers-data.js is present.");
        return;
      }

      powerLibrary.length = 0;
      for (const raw of EMBEDDED_POWERS) {
        const normPath = (raw.path || "").replace(/\\/g, "/");
        const content = typeof raw.content === "string" ? raw.content : (raw.content?.value ?? "");
        const base = {
          name: raw.name,
          path: normPath,
          content,
          levels: extractLevels(content),
        };
        base.meta = inferMeta(base);
        powerLibrary.push(base);
      }
      hydrateFilters();
      applyFilters();
      renderCharacterPowers();
      appliedLevel1Default = false;
      maybeApplyLevelOneFilter();
      elements.loadBtn.textContent = "Reload power data";
    }
    function addPowerToCharacter(power) {
      const existing = chosenPowers.get(power.path);
      if (existing) {
        renderCharacterPowers();
        return;
      }
      const target = { ...power, purchased: new Set() };
      chosenPowers.set(power.path, target);
      setDirty();
      renderCharacterPowers();
      updateSummary();
    }

    function extractLevels(text) {
      const safe = typeof text === "string" ? text : "";
      const lines = safe.split(/\r?\n/);
      const hasLevelTable = lines.some(l => /\|.*level/i.test(l) && l.includes("|"));
      if (hasLevelTable) {
        const rows = lines.filter(l => l.trim().startsWith("|") && l.includes("|"));
        const parsed = [];
        for (const row of rows.slice(2)) {
          const cells = row.split("|").map(c => c.trim()).filter(Boolean);
          if (cells.length >= 2) {
            const levelNum = parseInt(cells[0], 10);
            if (!isNaN(levelNum)) {
              const pointsCell = cells[1];
              const cost = Number(pointsCell);
              const body = cells.slice(2).join(" | ") || cells.slice(1).join(" | ");
              parsed.push({ level: levelNum, text: body, cost: isNaN(cost) ? 1 : cost });
            }
          }
        }
        if (parsed.length) return parsed.sort((a, b) => a.level - b.level);
      }

      const headings = [];
      lines.forEach((line, idx) => {
        const m = line.match(/^\s*#*\s*(?:Lv\.?\s*|Level\s*)(\d+)/i);
        if (m) headings.push({ idx, level: parseInt(m[1], 10) });
      });
      if (headings.length) {
        const chunks = [];
        headings.forEach((item, i) => {
          const start = item.idx + 1;
          const end = i + 1 < headings.length ? headings[i + 1].idx : lines.length;
          const section = lines.slice(start, end).join("\n").trim();
          chunks.push({ level: item.level, text: section || "(no text)", cost: 1 });
        });
        return chunks.sort((a, b) => a.level - b.level);
      }

      const inlineSplit = text.split(/(?=Lv\.?\s*\d+)/i);
      if (inlineSplit.length > 1) {
        const levels = [];
        inlineSplit.forEach(chunk => {
          const m = chunk.match(/Lv\.?\s*(\d+)/i);
          if (m) {
            const rest = chunk.replace(/Lv\.?\s*\d+/i, "").trim();
            levels.push({ level: parseInt(m[1], 10), text: rest || "(no text)" });
          }
        });
        if (levels.length) return levels.sort((a, b) => a.level - b.level);
      }

      return [{ level: 1, text: text.trim() || "(no text)", cost: 1 }];
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function formatMarkdown(md) {
      let out = escapeHtml(md || "");
      out = out.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      out = out.replace(/\*(.+?)\*/g, "<em>$1</em>");
      out = out.replace(/\n{2,}/g, "\n\n");
      return out.replace(/\n/g, "<br>");
    }

    function stripTables(text) {
      return text
        .split(/\r?\n/)
        .filter(line => !line.trim().startsWith("|"))
        .join("\n");
    }

    function markdownToPlain(md) {
      return (md || "")
        .replace(/\*\*(.+?)\*\*/g, "$1")
        .replace(/\*(.+?)\*/g, "$1")
        .replace(/<br\s*\/?>/gi, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function levelDescriptor(lv) {
      const plain = markdownToPlain(stripTables(lv.text || ""));
      if (!plain) return "";
      return plain.length > 80 ? plain.slice(0, 80) + "..." : plain;
    }

    function sanitizeFileName(name) {
      return (name || "character")
        .replace(/[<>:"/\\|?*]+/g, "_")
        .replace(/\s+/g, " ")
        .trim() || "character";
    }
    async function chooseCharacterFolder() {
      if (!window.showDirectoryPicker) {
        alert("Your browser does not support the File System Access API.");
        return;
      }
      characterDirHandle = await window.showDirectoryPicker();
      elements.characterFolderHint.textContent = `Folder: ${characterDirHandle.name || "selected"}`;
    }

    async function ensureCharacterFolder() {
      if (characterDirHandle) return characterDirHandle;
      await chooseCharacterFolder();
      return characterDirHandle;
    }

    function serializeCharacter() {
      return {
        name: document.getElementById("name").value || "",
        concept: document.getElementById("concept").value || "",
        background: elements.backgroundText.value || "",
        stats: {
          reflexBase: Number(elements.reflexBase.value) || 0,
          reflexMod: Number(elements.reflexMod.value) || 0,
          strengthBase: Number(elements.strengthBase.value) || 0,
          strengthMod: Number(elements.strengthMod.value) || 0,
          smartsBase: Number(elements.smartsBase.value) || 0,
          smartsMod: Number(elements.smartsMod.value) || 0,
          socialBase: Number(elements.socialBase.value) || 0,
          socialMod: Number(elements.socialMod.value) || 0,
          durabilityBase: Number(elements.durabilityBase.value) || 0,
          durabilityMod: Number(elements.durabilityMod.value) || 0,
          level: Number(document.getElementById("level").value) || 0,
        },
        budget: {
          base: Number(elements.statBasePool.value) || 0,
          perLevel: Number(elements.statPerLevel.value) || 0,
        },
        powers: Array.from(chosenPowers.values()).map(p => ({
          name: p.name,
          path: p.path,
          purchasedIndices: p.purchased ? Array.from(p.purchased) : [],
        })),
        inventory,
        savedAt: new Date().toISOString(),
      };
    }

    async function saveCharacterToFolder() {
      try {
        const dir = await ensureCharacterFolder();
        if (!dir) return;
        const data = serializeCharacter();
        const fileName = sanitizeFileName(data.name || "character") + ".json";
        const fileHandle = await dir.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(data, null, 2));
        await writable.close();
        lastSavedAt = data.savedAt;
        dirty = false;
        elements.saveStamp.textContent = `Last saved: ${formatTimestamp(lastSavedAt)}`;
        alert(`Character saved as ${fileName}`);
      } catch (err) {
        console.error(err);
        alert("Failed to save character. Check folder permissions.");
      }
    }

    function applyCharacter(data) {
      if (elements.sampleBanner) elements.sampleBanner.classList.add("hidden");
      document.getElementById("name").value = data.name || "";
      document.getElementById("concept").value = data.concept || "";
      elements.backgroundText.value = data.background || "";
      if (data.stats) {
        elements.reflexBase.value = data.stats.reflexBase ?? 0;
        elements.reflexMod.value = data.stats.reflexMod ?? 0;
        elements.strengthBase.value = data.stats.strengthBase ?? 0;
        elements.strengthMod.value = data.stats.strengthMod ?? 0;
        elements.smartsBase.value = data.stats.smartsBase ?? 0;
        elements.smartsMod.value = data.stats.smartsMod ?? 0;
        elements.socialBase.value = data.stats.socialBase ?? 0;
        elements.socialMod.value = data.stats.socialMod ?? 0;
        elements.durabilityBase.value = data.stats.durabilityBase ?? 0;
        elements.durabilityMod.value = data.stats.durabilityMod ?? 0;
        document.getElementById("level").value = data.stats.level ?? 1;
      }
      if (data.budget) {
        elements.statBasePool.value = data.budget.base ?? elements.statBasePool.value;
        elements.statPerLevel.value = data.budget.perLevel ?? elements.statPerLevel.value;
      }
      updateDerived();
      chosenPowers.clear();
      inventory.length = 0;
      if (data.powers && Array.isArray(data.powers)) {
        data.powers.forEach(saved => {
          const lib = powerLibrary.find(p => p.path === saved.path) || powerLibrary.find(p => p.name === saved.name);
          if (lib) {
            const purchased = new Set(saved.purchasedIndices || []);
            chosenPowers.set(lib.path, { ...lib, purchased });
          }
        });
      }
      if (data.inventory && Array.isArray(data.inventory)) {
        data.inventory.forEach(item => {
          if (item && item.name) {
            inventory.push({ name: item.name, qty: item.qty || 1, notes: item.notes || "" });
          }
        });
      }
      lastSavedAt = data.savedAt || null;
      elements.saveStamp.textContent = lastSavedAt ? `Last saved: ${formatTimestamp(lastSavedAt)}` : "Last saved: loaded";
      dirty = false;
      renderCharacterPowers();
      renderInventory();
      updateSummary();
    }
    async function loadCharacterFromFile() {
      try {
        if (window.showOpenFilePicker) {
          const [fileHandle] = await window.showOpenFilePicker({
            types: [{ description: "Character JSON", accept: { "application/json": [".json"] } }],
            multiple: false
          });
          const file = await fileHandle.getFile();
          const text = await file.text();
          const data = JSON.parse(text);
          applyCharacter(data);
          return;
        }
        const dir = await ensureCharacterFolder();
        if (!dir) return;
        const files = [];
        for await (const entry of dir.values()) {
          if (entry.kind === "file" && entry.name.toLowerCase().endsWith(".json")) {
            files.push(entry);
          }
        }
        if (files.length === 0) {
          alert("No character files found in this folder.");
          return;
        }
        const list = files.map(f => f.name).join("\n");
        const pick = prompt(`Enter the file name to load:\n${list}`, files[0].name);
        if (!pick) return;
        const chosen = files.find(f => f.name === pick.trim());
        if (!chosen) {
          alert("File not found in the selected folder.");
          return;
        }
        const file = await chosen.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        applyCharacter(data);
      } catch (err) {
        console.error(err);
        alert("Failed to load character. Check folder permissions.");
      }
    }

    function quickSave() {
      const data = serializeCharacter();
      localStorage.setItem(LOCAL_KEY, JSON.stringify(data));
      lastSavedAt = data.savedAt;
      dirty = false;
      elements.saveStamp.textContent = `Last saved: ${formatTimestamp(lastSavedAt)} (Quick Save)`;
      alert("Character saved to localStorage.");
    }

    function quickLoad() {
      const raw = localStorage.getItem(LOCAL_KEY);
      if (!raw) {
        alert("No saved character found in localStorage.");
        return;
      }
      try {
        const data = JSON.parse(raw);
        applyCharacter(data);
      } catch (err) {
        console.error(err);
        alert("Unable to load saved character.");
      }
    }

    function previewFromPower(power) {
      const tablePreview = (text) => {
        const lines = (text || "").split(/\r?\n/).filter(Boolean);
        const dataRows = lines.filter(l => l.includes("|") && !/^\\|\\s*-/.test(l));
        for (const row of dataRows.slice(1)) {
          const cells = row.split("|").map(c => c.trim()).filter(Boolean);
          if (cells.length >= 2) {
            const ability = cells[cells.length - 1];
            const plain = markdownToPlain(ability.replace(/<br\\s*\\/?\\s*>/gi, " "));
            if (plain) return plain;
          }
        }
        return "";
      };
      const sortedLevels = [...(power.levels || [])].sort((a, b) => a.level - b.level);
      const first = sortedLevels[0];
      const fromTable = tablePreview(first?.text || power.content || "");
      if (fromTable) return fromTable.length > 140 ? fromTable.slice(0, 140) + "..." : fromTable;
      const fallback = markdownToPlain(stripTables(power.content || ""));
      if (fallback) return fallback.length > 140 ? fallback.slice(0, 140) + "..." : fallback;
      return "No description";
    }

    function formatTimestamp(ts) {
      const date = new Date(ts);
      return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
    }

    function presetBuild(name) {
      const builds = {
        "Street Brawler": {
          level: 3,
          stats: { strengthBase: 4, durabilityBase: 3, reflexBase: 2, smartsBase: 1, socialBase: 0 },
          powers: ["Super Strength", "Vitality", "Invincibility"],
          inventory: [{ name: "Brass Knuckles", qty: 1, notes: "Adds +1 damage" }],
          background: "Bouncer turned vigilante who knows the alleys and takes no guff."
        },
        "Occult Investigator": {
          level: 3,
          stats: { smartsBase: 4, reflexBase: 2, socialBase: 2, durabilityBase: 1, strengthBase: 0 },
          powers: ["Clairvoyant", "Mind Control", "Teleport (People)"],
          inventory: [{ name: "Case Files", qty: 1, notes: "Advantage on research" }],
          background: "Detective with a taste for the uncanny; keeps red-string boards everywhere."
        },
        "Corporate Fixer": {
          level: 3,
          stats: { socialBase: 4, smartsBase: 3, reflexBase: 1, strengthBase: 1, durabilityBase: 1 },
          powers: ["Social", "Gadget Techie", "Interface Techie"],
          inventory: [{ name: "Company Credit", qty: 1, notes: "$ to grease palms" }],
          background: "Smooth operator on retainer; knows who to call and what they cost."
        }
      };
      const build = builds[name];
      if (!build) return;
      document.getElementById("level").value = build.level;
      Object.entries(build.stats).forEach(([key, val]) => {
        const el = elements[key];
        if (el) el.value = val;
      });
      chosenPowers.clear();
      build.powers.forEach(pName => {
        const lib = powerLibrary.find(p => p.name === pName);
        if (lib) {
          chosenPowers.set(lib.path, { ...lib, purchased: new Set([0]) });
        }
      });
      inventory.length = 0;
      build.inventory.forEach(item => inventory.push(item));
      elements.backgroundText.value = build.background || elements.backgroundText.value;
      setDirty();
      renderCharacterPowers();
      renderInventory();
      updateDerived();
      updateSummary();
      document.body.classList.add("tour");
      setTimeout(() => document.body.classList.remove("tour"), 6000);
    }

    function loadSampleStarter() {
      presetBuild("Street Brawler");
      elements.level.value = 1;
      elements.reflexBase.value = 1;
      elements.strengthBase.value = 3;
      elements.smartsBase.value = 1;
      elements.socialBase.value = 0;
      elements.durabilityBase.value = 2;
      ["reflexMod","strengthMod","smartsMod","socialMod","durabilityMod"].forEach(id => { elements[id].value = 0; });
      updateDerived();
      renderCharacterPowers();
      renderInventory();
      updateSummary();
      validateStats();
      setDirty();
      if (elements.sampleBanner) elements.sampleBanner.classList.remove("hidden");
      const sheetPanel = document.getElementById("sheetPanel");
      if (sheetPanel) sheetPanel.scrollIntoView({ behavior: "smooth", block: "start" });
      appliedLevel1Default = false;
      maybeApplyLevelOneFilter();
    }

    function applyBuildFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const build = params.get("build");
      const options = ["Street Brawler", "Occult Investigator", "Corporate Fixer"];
      if (build && options.includes(build)) {
        presetBuild(build);
        params.delete("build");
        const rest = params.toString();
        const newUrl = `${location.pathname}${rest ? "?" + rest : ""}${location.hash}`;
        history.replaceState({}, "", newUrl);
      }
    }
    ["level","reflexBase","reflexMod","strengthBase","strengthMod","smartsBase","smartsMod","socialBase","socialMod","durabilityBase","durabilityMod","statBasePool","statPerLevel"].forEach(id => {
      elements[id].addEventListener("input", () => {
        setDirty();
        updateDerived();
        if (id === "level") {
          appliedLevel1Default = false;
          maybeApplyLevelOneFilter();
        }
      });
    });
    elements.selectCharacterFolder.addEventListener("click", async () => {
      await saveCharacterToFolder();
    });
    elements.loadCharacter.addEventListener("click", async () => {
      await loadCharacterFromFile();
    });
    elements.loadBtn.addEventListener("click", () => {
      markFiltersTouched();
      hydrateFromEmbedded();
    });
    elements.search.addEventListener("input", () => {
      filters.search = elements.search.value;
      markFiltersTouched();
      applyFilters();
    });
    elements.filterClass.addEventListener("change", () => { filters.class = elements.filterClass.value; markFiltersTouched(); applyFilters(); });
    elements.filterLevel.addEventListener("change", () => { filters.level = elements.filterLevel.value; markFiltersTouched(); applyFilters(); });
    elements.filterCategory.addEventListener("change", () => { filters.category = elements.filterCategory.value; markFiltersTouched(); applyFilters(); });
    elements.filterAction.addEventListener("change", () => { filters.action = elements.filterAction.value; markFiltersTouched(); applyFilters(); });
    document.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        const key = chip.dataset.quick;
        markFiltersTouched();
        filters.class = "all";
        filters.level = "all";
        if (key === "clear") {
          elements.search.value = "";
          filters.search = "";
        } else if (key === "level1") {
          filters.level = "1";
        } else if (key === "level2") {
          filters.level = "2plus";
        } else if (key === "classBrick") {
          filters.class = "Brick";
        } else if (key === "classTechie") {
          filters.class = "Techie";
        } else if (key === "classRanger") {
          filters.class = "Ranger";
        }
        applyFilters();
      });
    });
    elements.addItem.addEventListener("click", () => {
      const name = elements.invName.value.trim();
      const qty = Number(elements.invQty.value) || 1;
      const notes = elements.invNotes.value.trim();
      if (!name) {
        alert("Item name is required.");
        return;
      }
      inventory.push({ name, qty, notes });
      elements.invName.value = "";
      elements.invQty.value = 1;
      elements.invNotes.value = "";
      setDirty();
      renderInventory();
      updateSummary();
    });
    elements.printCharacter.addEventListener("click", () => {
      window.print();
    });
    elements.startTourLink.addEventListener("click", () => {
      loadSampleStarter();
    });
    elements.powerDetail.addEventListener("click", (e) => e.stopPropagation());
    elements.addFromDetail.addEventListener("click", () => {
      if (selectedPower) addPowerToCharacter(selectedPower);
    });
    elements.closeDetail.addEventListener("click", () => {
      elements.powerDetail.classList.add("hidden");
      if (elements.detailWrapper) elements.detailWrapper.classList.add("hidden");
    });
    [elements.quickSave, elements.quickSaveInline].forEach(btn => btn.addEventListener("click", quickSave));
    [elements.quickLoad, elements.quickLoadInline].forEach(btn => btn.addEventListener("click", quickLoad));
    elements.backgroundText.addEventListener("input", () => setDirty());

    window.addEventListener("beforeunload", (e) => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    });

    hydrateFromEmbedded();
    applyBuildFromQuery();
    maybeApplyLevelOneFilter();
    renderInventory();
    renderCharacterPowers();
    updateDerived();
    updateSummary();
  </script>
</body>
</html>








